<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רשת הופפילד - 3 נוירונים - הרצה צעד אחר צעד</title>
    <style>
        :root {
            --bg: #0b1220;
            --card-bg: #141d2b;
            --border: #2d3a4f;
            --ink: #e5e7eb;
            --teal: #11a8a0;
            --magenta: #f472b6;
            --purple: #a78bfa;
            --green: #22c55e;
            --orange: #f59e0b;
            --red: #ef4444;
            --calc-bg: #0c1526;
            --blue: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--ink);
            min-height: 100vh;
            padding: 20px;
            font-size: 1rem;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--teal);
            font-size: 1.8rem;
            font-weight: 400;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 20px;
            color: var(--ink);
            opacity: 0.7;
            font-size: 1rem;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .phase {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }

        .phase.learning {
            border-color: var(--purple);
        }

        .phase.running {
            border-color: var(--green);
        }

        .phase.history {
            border-color: var(--orange);
        }

        .phase-title {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .phase.learning .phase-title {
            color: var(--purple);
        }

        .phase.running .phase-title {
            color: var(--green);
        }

        .phase.history .phase-title {
            color: var(--orange);
        }

        .phase-description {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Triangle Diagram SVG */
        .diagram-container {
            margin-bottom: 15px;
        }

        .diagram-svg {
            width: 100%;
            height: 220px;
        }

        .neuron-label {
            font-family: 'Times New Roman', serif;
            font-size: 20px;
            fill: var(--ink);
            font-weight: bold;
        }

        .weight-label {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 14px;
            fill: var(--orange);
        }

        .edge {
            stroke: var(--purple);
            stroke-width: 3;
            fill: none;
        }

        .value-display-svg {
            font-family: monospace;
            font-size: 16px;
            fill: var(--orange);
        }

        /* Pattern selection */
        .pattern-selection {
            margin-bottom: 15px;
        }

        .pattern-selection h3 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--ink);
            font-weight: 400;
            font-size: 1rem;
        }

        .patterns-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            max-width: 380px;
            margin: 0 auto;
        }

        .pattern-btn {
            padding: 8px 4px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--calc-bg);
            color: var(--ink);
            cursor: pointer;
            font-size: 0.85rem;
            font-family: monospace;
            transition: all 0.2s;
        }

        .pattern-btn:hover {
            border-color: var(--purple);
        }

        .pattern-btn.selected {
            border-color: var(--green);
            background: rgba(34, 197, 94, 0.2);
        }

        /* Weight Matrix */
        .matrix-container {
            margin-bottom: 15px;
        }

        .matrix-container h3 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--ink);
            font-weight: 400;
            font-size: 1rem;
        }

        .matrix-table {
            margin: 0 auto;
            border-collapse: collapse;
        }

        .matrix-table td {
            padding: 6px 10px;
            text-align: center;
            font-family: 'Times New Roman', serif;
            font-size: 1rem;
            border: 1px solid var(--border);
        }

        .matrix-table .header {
            color: var(--purple);
            font-style: italic;
            background: rgba(167, 139, 250, 0.1);
        }

        .matrix-table .row-header {
            color: var(--teal);
            font-style: italic;
            background: rgba(17, 168, 160, 0.1);
        }

        .matrix-table .zero {
            color: #666;
        }

        /* State selection */
        .state-selection {
            margin-bottom: 15px;
        }

        .state-selection h3 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--ink);
            font-weight: 400;
            font-size: 1rem;
        }

        .states-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            max-width: 380px;
            margin: 0 auto;
        }

        .state-btn {
            padding: 8px 4px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--calc-bg);
            color: var(--ink);
            cursor: pointer;
            font-size: 0.85rem;
            font-family: monospace;
            transition: all 0.2s;
        }

        .state-btn:hover {
            border-color: var(--orange);
        }

        .state-btn.selected {
            border-color: var(--orange);
            background: rgba(245, 158, 11, 0.2);
        }

        .state-btn.stored {
            color: var(--green);
        }

        /* Control buttons */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--calc-bg);
            color: var(--ink);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .control-btn:hover {
            border-color: var(--teal);
            background: rgba(17, 168, 160, 0.2);
        }

        .control-btn.primary {
            border-color: var(--green);
            background: rgba(34, 197, 94, 0.2);
        }

        .control-btn.primary:hover {
            background: rgba(34, 197, 94, 0.4);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Energy display */
        .energy-display {
            text-align: center;
            padding: 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--green);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .energy-display h3 {
            margin-bottom: 8px;
            color: var(--ink);
            font-weight: 400;
            font-size: 1rem;
        }

        .energy-value {
            font-size: 1.5rem;
            font-family: 'Times New Roman', serif;
            color: var(--green);
        }

        /* Status display */
        .status-display {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .status-display.running {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--orange);
            color: var(--orange);
        }

        .status-display.converged {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--green);
            color: var(--green);
        }

        /* History table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .history-table th, .history-table td {
            padding: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .history-table th {
            background: rgba(17, 168, 160, 0.2);
            color: var(--teal);
            font-weight: 400;
        }

        .history-table tr.current {
            background: rgba(245, 158, 11, 0.2);
        }

        .history-table tr.initial {
            background: rgba(167, 139, 250, 0.15);
        }

        .history-table .changed {
            color: var(--orange);
            font-weight: bold;
        }

        /* Calculation details */
        .calc-details {
            background: var(--calc-bg);
            border: 1px dashed var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .calc-details h4 {
            color: var(--teal);
            margin-bottom: 10px;
            font-weight: 400;
            font-size: 1rem;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-family: 'Times New Roman', serif;
        }

        .calc-row:last-child {
            border-bottom: none;
        }

        .calc-row .label {
            color: var(--ink);
            opacity: 0.8;
        }

        .calc-row .value {
            font-family: monospace;
            color: var(--orange);
        }

        .calc-row.highlight {
            background: rgba(34, 197, 94, 0.1);
            margin: 0 -12px;
            padding: 6px 12px;
        }

        .calc-row.highlight .value {
            color: var(--green);
            font-weight: bold;
        }

        /* All states energy table */
        .all-states-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 15px;
        }

        .all-states-table th, .all-states-table td {
            padding: 6px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .all-states-table th {
            background: rgba(17, 168, 160, 0.2);
            color: var(--teal);
            font-weight: 400;
        }

        .all-states-table tr.stored {
            color: var(--green);
        }

        .all-states-table tr.minimum {
            background: rgba(34, 197, 94, 0.15);
        }

        .all-states-table tr.current-state {
            background: rgba(245, 158, 11, 0.2);
        }

        /* Neuron colors */
        .neuron-a { color: var(--teal); }
        .neuron-b { color: var(--magenta); }
        .neuron-c { color: var(--blue); }

        .hl-teal { color: var(--teal); font-weight: 500; }
        .hl-magenta { color: var(--magenta); font-weight: 500; }
        .hl-blue { color: var(--blue); font-weight: 500; }
        .hl-purple { color: var(--purple); font-weight: 500; }
        .hl-green { color: var(--green); font-weight: 500; }
        .hl-orange { color: var(--orange); font-weight: 500; }

        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }
            .phase.history {
                grid-column: span 2;
            }
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
            .phase.history {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <h1>רשת הופפילד - 3 נוירונים</h1>
    <div class="subtitle">הרצה צעד אחר צעד עד התכנסות</div>

    <div class="container">
        <!-- Column 1: Learning Phase -->
        <div class="phase learning">
            <div class="phase-title">שלב 1: למידה</div>

            <div class="phase-description">
                בחרו דפוסים לאחסון ברשת.<br>
                המשקלים יחושבו אוטומטית לפי כלל Hebb.
            </div>

            <!-- Triangle Diagram -->
            <div class="diagram-container">
                <svg class="diagram-svg" viewBox="0 0 400 220">
                    <!-- Edges -->
                    <line id="edge-ab" x1="100" y1="180" x2="300" y2="180" class="edge" />
                    <line id="edge-ac" x1="100" y1="180" x2="200" y2="50" class="edge" />
                    <line id="edge-bc" x1="300" y1="180" x2="200" y2="50" class="edge" />

                    <!-- Weight labels -->
                    <text id="weight-ab" x="200" y="210" text-anchor="middle" class="weight-label">J<tspan dy="3" font-size="10">AB</tspan><tspan dy="-3"> = 0</tspan></text>
                    <text id="weight-ac" x="130" y="105" text-anchor="middle" class="weight-label">J<tspan dy="3" font-size="10">AC</tspan><tspan dy="-3"> = 0</tspan></text>
                    <text id="weight-bc" x="270" y="105" text-anchor="middle" class="weight-label">J<tspan dy="3" font-size="10">BC</tspan><tspan dy="-3"> = 0</tspan></text>

                    <!-- Neuron A -->
                    <g id="neuron-a-group">
                        <circle id="neuron-a" cx="100" cy="180" r="30" fill="var(--teal)" />
                        <text x="100" y="185" text-anchor="middle" class="neuron-label">A</text>
                    </g>

                    <!-- Neuron B -->
                    <g id="neuron-b-group">
                        <circle id="neuron-b" cx="300" cy="180" r="30" fill="var(--magenta)" />
                        <text x="300" y="185" text-anchor="middle" class="neuron-label">B</text>
                    </g>

                    <!-- Neuron C -->
                    <g id="neuron-c-group">
                        <circle id="neuron-c" cx="200" cy="50" r="30" fill="var(--blue)" />
                        <text x="200" y="55" text-anchor="middle" class="neuron-label">C</text>
                    </g>

                    <!-- State values -->
                    <text id="value-a" x="55" y="185" text-anchor="middle" class="value-display-svg">−</text>
                    <text id="value-b" x="345" y="185" text-anchor="middle" class="value-display-svg">−</text>
                    <text id="value-c" x="200" y="15" text-anchor="middle" class="value-display-svg">−</text>
                </svg>
            </div>

            <div class="pattern-selection">
                <h3>בחרו דפוסים לאחסון (A, B, C):</h3>
                <div class="patterns-grid">
                    <button class="pattern-btn" data-pattern="1,1,1">(+,+,+)</button>
                    <button class="pattern-btn" data-pattern="1,1,-1">(+,+,−)</button>
                    <button class="pattern-btn" data-pattern="1,-1,1">(+,−,+)</button>
                    <button class="pattern-btn" data-pattern="1,-1,-1">(+,−,−)</button>
                    <button class="pattern-btn" data-pattern="-1,1,1">(−,+,+)</button>
                    <button class="pattern-btn" data-pattern="-1,1,-1">(−,+,−)</button>
                    <button class="pattern-btn" data-pattern="-1,-1,1">(−,−,+)</button>
                    <button class="pattern-btn" data-pattern="-1,-1,-1">(−,−,−)</button>
                </div>
            </div>

            <div class="matrix-container">
                <h3>מטריצת המשקלים:</h3>
                <table class="matrix-table">
                    <tr>
                        <td class="header">J</td>
                        <td class="header">A</td>
                        <td class="header">B</td>
                        <td class="header">C</td>
                    </tr>
                    <tr>
                        <td class="row-header">A</td>
                        <td class="zero">0</td>
                        <td id="j-ab">0</td>
                        <td id="j-ac">0</td>
                    </tr>
                    <tr>
                        <td class="row-header">B</td>
                        <td id="j-ba">0</td>
                        <td class="zero">0</td>
                        <td id="j-bc">0</td>
                    </tr>
                    <tr>
                        <td class="row-header">C</td>
                        <td id="j-ca">0</td>
                        <td id="j-cb">0</td>
                        <td class="zero">0</td>
                    </tr>
                </table>
            </div>

            <table class="all-states-table">
                <thead>
                    <tr>
                        <th>מצב (A,B,C)</th>
                        <th>אנרגיה E</th>
                        <th>שמור?</th>
                    </tr>
                </thead>
                <tbody id="all-states-tbody">
                </tbody>
            </table>
        </div>

        <!-- Column 2: Running Phase -->
        <div class="phase running">
            <div class="phase-title">שלב 2: הרצה</div>

            <div class="phase-description">
                בחרו מצב התחלתי והריצו את הרשת צעד אחר צעד.
            </div>

            <div class="state-selection">
                <h3>בחרו מצב התחלתי (A, B, C):</h3>
                <div class="states-grid" id="states-grid">
                    <button class="state-btn" data-state="1,1,1">(+,+,+)</button>
                    <button class="state-btn" data-state="1,1,-1">(+,+,−)</button>
                    <button class="state-btn" data-state="1,-1,1">(+,−,+)</button>
                    <button class="state-btn" data-state="1,-1,-1">(+,−,−)</button>
                    <button class="state-btn" data-state="-1,1,1">(−,+,+)</button>
                    <button class="state-btn" data-state="-1,1,-1">(−,+,−)</button>
                    <button class="state-btn" data-state="-1,-1,1">(−,−,+)</button>
                    <button class="state-btn" data-state="-1,-1,-1">(−,−,−)</button>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn primary" id="step-btn">צעד אחד</button>
                <button class="control-btn" id="run-btn">הרץ עד התכנסות</button>
                <button class="control-btn" id="reset-btn">אפס</button>
            </div>

            <div class="status-display running" id="status-display">
                בחרו מצב התחלתי
            </div>

            <div class="energy-display">
                <h3>אנרגיה נוכחית:</h3>
                <div class="energy-value" id="current-energy">E = 0</div>
            </div>

            <div class="calc-details" id="calc-details">
                <h4>חישוב הצעד הבא:</h4>
                <div id="next-step-calc">
                    בחרו מצב התחלתי כדי לראות את החישוב
                </div>
            </div>
        </div>

        <!-- Column 3: History -->
        <div class="phase history">
            <div class="phase-title">היסטוריית ההרצה</div>

            <div class="phase-description">
                כל הצעדים מההתחלה ועד ההתכנסות
            </div>

            <table class="history-table">
                <thead>
                    <tr>
                        <th>צעד</th>
                        <th>A</th>
                        <th>B</th>
                        <th>C</th>
                        <th>אנרגיה E</th>
                        <th>נוירון שהתעדכן</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // State
        let storedPatterns = [];
        let weights = { ab: 0, ac: 0, bc: 0 };
        let currentState = { a: 1, b: 1, c: 1 };
        let history = [];
        let stepCount = 0;
        let isConverged = false;
        let lastUpdatedNeuron = null;
        const N = 3;

        // DOM elements
        const patternBtns = document.querySelectorAll('.pattern-btn');
        const stateBtns = document.querySelectorAll('.state-btn');
        const stepBtn = document.getElementById('step-btn');
        const runBtn = document.getElementById('run-btn');
        const resetBtn = document.getElementById('reset-btn');
        const statusDisplay = document.getElementById('status-display');
        const currentEnergyDisplay = document.getElementById('current-energy');
        const historyTbody = document.getElementById('history-tbody');
        const allStatesTbody = document.getElementById('all-states-tbody');
        const calcDetails = document.getElementById('next-step-calc');

        // SVG elements
        const edgeAB = document.getElementById('edge-ab');
        const edgeAC = document.getElementById('edge-ac');
        const edgeBC = document.getElementById('edge-bc');
        const weightAB = document.getElementById('weight-ab');
        const weightAC = document.getElementById('weight-ac');
        const weightBC = document.getElementById('weight-bc');
        const valueA = document.getElementById('value-a');
        const valueB = document.getElementById('value-b');
        const valueC = document.getElementById('value-c');
        const neuronA = document.getElementById('neuron-a');
        const neuronB = document.getElementById('neuron-b');
        const neuronC = document.getElementById('neuron-c');

        // Matrix cells
        const jAB = document.getElementById('j-ab');
        const jAC = document.getElementById('j-ac');
        const jBA = document.getElementById('j-ba');
        const jBC = document.getElementById('j-bc');
        const jCA = document.getElementById('j-ca');
        const jCB = document.getElementById('j-cb');

        // Calculate weights from stored patterns
        function calculateWeights() {
            if (storedPatterns.length === 0) {
                weights = { ab: 0, ac: 0, bc: 0 };
                return;
            }

            let sumAB = 0, sumAC = 0, sumBC = 0;
            for (const p of storedPatterns) {
                sumAB += p.a * p.b;
                sumAC += p.a * p.c;
                sumBC += p.b * p.c;
            }
            weights.ab = sumAB / N;
            weights.ac = sumAC / N;
            weights.bc = sumBC / N;
        }

        // Calculate energy for a state
        function calcEnergy(state) {
            return -(weights.ab * state.a * state.b +
                     weights.ac * state.a * state.c +
                     weights.bc * state.b * state.c);
        }

        // Calculate local field for a neuron
        function calcLocalField(neuron, state) {
            if (neuron === 'a') {
                return weights.ab * state.b + weights.ac * state.c;
            } else if (neuron === 'b') {
                return weights.ab * state.a + weights.bc * state.c;
            } else {
                return weights.ac * state.a + weights.bc * state.b;
            }
        }

        // Format number with sign
        function formatNum(n) {
            if (typeof n !== 'number' || isNaN(n)) return '0';
            const formatted = n.toFixed(2);
            return (n >= 0 ? '+' : '') + formatted;
        }

        function formatSign(n) {
            return n >= 0 ? '+' : '−';
        }

        function formatState(n) {
            return n >= 0 ? '+1' : '−1';
        }

        // Update SVG diagram
        function updateDiagram() {
            // Update weight labels
            weightAB.innerHTML = `J<tspan dy="3" font-size="10">AB</tspan><tspan dy="-3"> = ${formatNum(weights.ab)}</tspan>`;
            weightAC.innerHTML = `J<tspan dy="3" font-size="10">AC</tspan><tspan dy="-3"> = ${formatNum(weights.ac)}</tspan>`;
            weightBC.innerHTML = `J<tspan dy="3" font-size="10">BC</tspan><tspan dy="-3"> = ${formatNum(weights.bc)}</tspan>`;

            // Update edge colors
            edgeAB.setAttribute('stroke', weights.ab > 0 ? '#a78bfa' : weights.ab < 0 ? '#ef4444' : '#4b5563');
            edgeAC.setAttribute('stroke', weights.ac > 0 ? '#a78bfa' : weights.ac < 0 ? '#ef4444' : '#4b5563');
            edgeBC.setAttribute('stroke', weights.bc > 0 ? '#a78bfa' : weights.bc < 0 ? '#ef4444' : '#4b5563');

            // Update neuron values
            valueA.textContent = formatState(currentState.a);
            valueB.textContent = formatState(currentState.b);
            valueC.textContent = formatState(currentState.c);

            // Update neuron colors based on state
            neuronA.setAttribute('fill', currentState.a > 0 ? 'var(--teal)' : '#1e4047');
            neuronB.setAttribute('fill', currentState.b > 0 ? 'var(--magenta)' : '#4a2040');
            neuronC.setAttribute('fill', currentState.c > 0 ? 'var(--blue)' : '#1e3a5f');
        }

        // Update weight matrix display
        function updateMatrixDisplay() {
            jAB.textContent = formatNum(weights.ab);
            jAC.textContent = formatNum(weights.ac);
            jBA.textContent = formatNum(weights.ab);
            jBC.textContent = formatNum(weights.bc);
            jCA.textContent = formatNum(weights.ac);
            jCB.textContent = formatNum(weights.bc);

            // Color the cells
            [jAB, jBA].forEach(cell => cell.style.color = weights.ab >= 0 ? 'var(--green)' : 'var(--red)');
            [jAC, jCA].forEach(cell => cell.style.color = weights.ac >= 0 ? 'var(--green)' : 'var(--red)');
            [jBC, jCB].forEach(cell => cell.style.color = weights.bc >= 0 ? 'var(--green)' : 'var(--red)');
        }

        // Update all states energy table
        function updateAllStatesTable() {
            const states = [
                { a: 1, b: 1, c: 1, label: '(+,+,+)' },
                { a: 1, b: 1, c: -1, label: '(+,+,−)' },
                { a: 1, b: -1, c: 1, label: '(+,−,+)' },
                { a: 1, b: -1, c: -1, label: '(+,−,−)' },
                { a: -1, b: 1, c: 1, label: '(−,+,+)' },
                { a: -1, b: 1, c: -1, label: '(−,+,−)' },
                { a: -1, b: -1, c: 1, label: '(−,−,+)' },
                { a: -1, b: -1, c: -1, label: '(−,−,−)' }
            ];

            const energies = states.map(s => ({ ...s, E: calcEnergy(s) }));
            const minE = Math.min(...energies.map(e => e.E));

            allStatesTbody.innerHTML = energies.map(s => {
                const isStored = storedPatterns.some(p => p.a === s.a && p.b === s.b && p.c === s.c);
                const isMin = s.E === minE && (weights.ab !== 0 || weights.ac !== 0 || weights.bc !== 0);
                const isCurrent = s.a === currentState.a && s.b === currentState.b && s.c === currentState.c;

                let classes = [];
                if (isStored) classes.push('stored');
                if (isMin) classes.push('minimum');
                if (isCurrent) classes.push('current-state');

                return `<tr class="${classes.join(' ')}">
                    <td>${s.label}</td>
                    <td>${formatNum(s.E)}</td>
                    <td>${isStored ? '✓' : ''}</td>
                </tr>`;
            }).join('');

            // Update state buttons to show which are stored
            stateBtns.forEach(btn => {
                const [a, b, c] = btn.dataset.state.split(',').map(Number);
                const isStored = storedPatterns.some(p => p.a === a && p.b === b && p.c === c);
                btn.classList.toggle('stored', isStored);
            });
        }

        // Update current energy display
        function updateEnergyDisplay() {
            const E = calcEnergy(currentState);
            currentEnergyDisplay.textContent = `E = ${formatNum(E)}`;
        }

        // Update next step calculation details
        function updateCalcDetails() {
            if (isConverged) {
                calcDetails.innerHTML = `
                    <h4>✓ המערכת התכנסה!</h4>
                    <div style="color: var(--green); margin-top: 10px;">
                        המצב הנוכחי הוא מינימום מקומי.<br>
                        שום נוירון לא ישנה את ערכו.
                    </div>
                `;
                return;
            }

            const neurons = ['a', 'b', 'c'];
            const neuronNames = { a: 'A', b: 'B', c: 'C' };
            const neuronColors = { a: 'var(--teal)', b: 'var(--magenta)', c: 'var(--blue)' };

            let html = '<h4>חישוב השדה המקומי לכל נוירון:</h4>';

            neurons.forEach(n => {
                const h = calcLocalField(n, currentState);
                const currentVal = currentState[n];
                const newVal = h >= 0 ? 1 : -1;
                const willChange = newVal !== currentVal;

                const otherNeurons = neurons.filter(x => x !== n);
                const weightTerms = otherNeurons.map(other => {
                    const w = n < other ? weights[n + other] : weights[other + n];
                    const v = currentState[other];
                    return `J<sub>${neuronNames[n]}${neuronNames[other]}</sub>·${neuronNames[other]}`;
                }).join(' + ');

                const valueTerms = otherNeurons.map(other => {
                    const w = n < other ? weights[n + other] : weights[other + n];
                    const v = currentState[other];
                    return `(${formatNum(w)})·(${formatState(v)})`;
                }).join(' + ');

                html += `
                    <div class="calc-row ${willChange ? 'highlight' : ''}">
                        <span class="label">
                            h<sub style="color: ${neuronColors[n]}">${neuronNames[n]}</sub> = ${weightTerms}
                        </span>
                        <span class="value">${valueTerms} = ${formatNum(h)}</span>
                    </div>
                    <div class="calc-row" style="padding-right: 20px; font-size: 0.9rem;">
                        <span class="label" style="opacity: 0.7;">
                            → sign(h<sub>${neuronNames[n]}</sub>) = ${formatState(newVal)}
                            ${willChange ? `<span style="color: var(--orange);">(ישתנה מ-${formatState(currentVal)}!)</span>` : '(ללא שינוי)'}
                        </span>
                    </div>
                `;
            });

            calcDetails.innerHTML = html;
        }

        // Add entry to history
        function addToHistory(updatedNeuron = null) {
            const E = calcEnergy(currentState);
            history.push({
                step: stepCount,
                state: { ...currentState },
                energy: E,
                updatedNeuron: updatedNeuron
            });
            updateHistoryTable();
        }

        // Update history table
        function updateHistoryTable() {
            historyTbody.innerHTML = history.map((h, idx) => {
                const isLast = idx === history.length - 1;
                const isFirst = idx === 0;

                const aChanged = idx > 0 && h.state.a !== history[idx-1].state.a;
                const bChanged = idx > 0 && h.state.b !== history[idx-1].state.b;
                const cChanged = idx > 0 && h.state.c !== history[idx-1].state.c;

                return `<tr class="${isLast ? 'current' : ''} ${isFirst ? 'initial' : ''}">
                    <td>${h.step}</td>
                    <td class="${aChanged ? 'changed' : ''}">${formatState(h.state.a)}</td>
                    <td class="${bChanged ? 'changed' : ''}">${formatState(h.state.b)}</td>
                    <td class="${cChanged ? 'changed' : ''}">${formatState(h.state.c)}</td>
                    <td>${formatNum(h.energy)}</td>
                    <td>${h.updatedNeuron ? h.updatedNeuron.toUpperCase() : '−'}</td>
                </tr>`;
            }).join('');
        }

        // Update status display
        function updateStatus() {
            if (isConverged) {
                statusDisplay.className = 'status-display converged';
                statusDisplay.textContent = '✓ התכנסות! המערכת הגיעה למצב יציב';
            } else if (history.length > 0) {
                statusDisplay.className = 'status-display running';
                statusDisplay.textContent = `צעד ${stepCount} - ממשיכים...`;
            } else {
                statusDisplay.className = 'status-display running';
                statusDisplay.textContent = 'בחרו מצב התחלתי';
            }
        }

        // Perform one update step (asynchronous update - one neuron at a time)
        function doStep() {
            if (isConverged) return false;

            // Try updating each neuron in order
            const neurons = ['a', 'b', 'c'];
            let changed = false;
            let updatedNeuron = null;

            // Always check in alphabetical order (A, B, C)
            for (let i = 0; i < 3; i++) {
                const n = neurons[i];
                const h = calcLocalField(n, currentState);
                const newVal = h >= 0 ? 1 : -1;

                if (newVal !== currentState[n]) {
                    currentState[n] = newVal;
                    changed = true;
                    updatedNeuron = n;
                    break;
                }
            }

            if (!changed) {
                isConverged = true;
            }

            stepCount++;
            addToHistory(updatedNeuron);
            updateAll();

            return changed;
        }

        // Run until convergence
        function runUntilConvergence() {
            let maxSteps = 100;
            let steps = 0;

            const interval = setInterval(() => {
                if (isConverged || steps >= maxSteps) {
                    clearInterval(interval);
                    return;
                }
                doStep();
                steps++;
            }, 500);
        }

        // Reset the running phase
        function resetRun() {
            currentState = { a: 1, b: 1, c: 1 };
            history = [];
            stepCount = 0;
            isConverged = false;
            lastUpdatedNeuron = null;

            stateBtns.forEach(btn => btn.classList.remove('selected'));
            updateAll();
        }

        // Update all displays
        function updateAll() {
            updateDiagram();
            updateMatrixDisplay();
            updateAllStatesTable();
            updateEnergyDisplay();
            updateCalcDetails();
            updateStatus();
        }

        // Pattern button click
        patternBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const [a, b, c] = btn.dataset.pattern.split(',').map(Number);
                const pattern = { a, b, c };

                const existingIndex = storedPatterns.findIndex(p => p.a === a && p.b === b && p.c === c);
                if (existingIndex >= 0) {
                    storedPatterns.splice(existingIndex, 1);
                    btn.classList.remove('selected');
                } else {
                    storedPatterns.push(pattern);
                    btn.classList.add('selected');
                }

                calculateWeights();
                resetRun();
            });
        });

        // State button click
        stateBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const [a, b, c] = btn.dataset.state.split(',').map(Number);
                currentState = { a, b, c };
                history = [];
                stepCount = 0;
                isConverged = false;

                stateBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');

                addToHistory(null);
                updateAll();
            });
        });

        // Control buttons
        stepBtn.addEventListener('click', doStep);
        runBtn.addEventListener('click', runUntilConvergence);
        resetBtn.addEventListener('click', resetRun);

        // Initial render
        updateAll();
    </script>
</body>
</html>
